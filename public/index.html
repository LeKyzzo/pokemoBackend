<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Console API Pokémon (mini)</title>
  <style>
    :root {
      font-family: "Segoe UI", -apple-system, BlinkMacSystemFont, "Helvetica Neue", sans-serif;
      color-scheme: light;
    }

    body {
      margin: 0;
      background: #f5f7fb;
      color: #1f2937;
    }

    main {
      max-width: 920px;
      margin: 0 auto;
      padding: 2.5rem 1.5rem 3rem;
    }

    h1 {
      margin-bottom: 0.35rem;
      font-size: clamp(1.8rem, 4vw, 2.3rem);
    }

    p.description {
      margin-top: 0;
      margin-bottom: 1.2rem;
      color: #4b5563;
    }

    label.base-url {
      display: inline-flex;
      flex-direction: column;
      gap: 0.35rem;
      font-size: 0.9rem;
      color: #374151;
    }

    label.base-url input {
      padding: 0.5rem 0.75rem;
      border: 1px solid #d1d5db;
      border-radius: 0.55rem;
      font: inherit;
      min-width: 260px;
    }

    section {
      margin-top: 2rem;
    }

    section h2 {
      margin-bottom: 0.75rem;
      font-size: 1.1rem;
    }

    .preset-list {
      display: grid;
      gap: 0.6rem;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    }

    button.preset {
      appearance: none;
      border: 1px solid #d1d5db;
      border-radius: 0.65rem;
      padding: 0.75rem 0.9rem;
      text-align: left;
      font: inherit;
      background: #ffffff;
      cursor: pointer;
      transition: border-color 0.15s ease, box-shadow 0.15s ease, transform 0.15s ease;
    }

    button.preset strong {
      display: block;
      font-size: 0.95rem;
      margin-bottom: 0.35rem;
    }

    button.preset span {
      display: block;
      font-size: 0.82rem;
      color: #6b7280;
    }

    button.preset.active {
      border-color: #2563eb;
      box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.2);
      transform: translateY(-1px);
    }

    button.preset:hover {
      border-color: #2563eb;
    }

    pre {
      background: #111827;
      color: #e5e7eb;
      padding: 1rem;
      border-radius: 0.65rem;
      margin: 0;
      min-height: 120px;
      overflow-x: auto;
      font-family: "JetBrains Mono", "Fira Code", "Cascadia Mono", ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 0.9rem;
      line-height: 1.5;
      white-space: pre-wrap;
    }

    .status {
      margin-bottom: 0.65rem;
      font-weight: 600;
      color: #1f2937;
    }

    .status.error {
      color: #dc2626;
    }

    .status.success {
      color: #047857;
    }

    .hint {
      margin-top: 0.5rem;
      font-size: 0.82rem;
      color: #6b7280;
    }
  </style>
</head>
<body>
  <main>
    <header>
      <h1>Console API Pokémon</h1>
      <p class="description">Cliquez sur une pré-requête pour l'envoyer tout de suite. On affiche la requête et la réponse ci-dessous et tout est aussi loggé dans la console du navigateur.</p>
      <label class="base-url">
        URL de base
        <input type="text" id="base-url" spellcheck="false" />
      </label>
    </header>

    <section>
      <h2>Pré-requêtes</h2>
      <div class="preset-list" id="preset-list"></div>
      <p class="hint">Besoin de personnaliser ? Modifiez directement le tableau <code>endpoints</code> dans le script.</p>
    </section>

    <section>
      <h2>Dernière requête envoyée</h2>
      <pre id="request-output">{ "status": "En attente d'une requête" }</pre>
    </section>

    <section>
      <h2>Dernière réponse reçue</h2>
      <div class="status" id="response-status">En attente…</div>
      <pre id="response-output"></pre>
    </section>
  </main>

  <script>
    const endpoints = [
      { id: 'health', label: 'GET /api/health', description: 'Ping de santé rapide', method: 'GET', path: '/api/health' },
      { id: 'snapshot', label: 'GET /api/database', description: 'Snapshot complet de la base', method: 'GET', path: '/api/database' },
      { id: 'trainers-list', label: 'GET /api/trainers', description: 'Lister tous les dresseurs', method: 'GET', path: '/api/trainers' },
      { id: 'trainer-get', label: 'GET /api/trainers/1', description: 'Afficher un dresseur', method: 'GET', path: '/api/trainers/1' },
      { id: 'trainer-create', label: 'POST /api/trainers', description: 'Créer un dresseur', method: 'POST', path: '/api/trainers', body: () => ({ name: `Dresseur_${Date.now().toString(36)}` }) },
      { id: 'trainer-heal', label: 'POST /api/trainers/1/heal', description: 'Soigner équipe', method: 'POST', path: '/api/trainers/1/heal' },
      { id: 'trainer-add-pokemon', label: 'POST /api/trainers/1/add-pokemon', description: 'Ajouter un Pokémon à un dresseur', method: 'POST', path: '/api/trainers/1/add-pokemon', body: () => ({ name: `Testchu_${Date.now().toString(36)}`, maxLife: 120 }) },
      { id: 'pokemons-create', label: 'POST /api/pokemons', description: 'Créer un Pokémon', method: 'POST', path: '/api/pokemons', body: () => ({ name: `Capture_${Date.now().toString(36)}`, maxLife: 110, trainerId: 1 }) },
      { id: 'pokemon-get', label: 'GET /api/pokemons/1', description: 'Afficher un Pokémon', method: 'GET', path: '/api/pokemons/1' },
      { id: 'pokemon-by-trainer', label: 'GET /api/pokemons/trainer/1', description: 'Lister les Pokémons d’un dresseur', method: 'GET', path: '/api/pokemons/trainer/1' },
      { id: 'pokemon-heal', label: 'POST /api/pokemons/1/heal', description: 'Soigner un Pokémon', method: 'POST', path: '/api/pokemons/1/heal' },
      { id: 'pokemon-add-attack', label: 'POST /api/pokemons/1/attacks', description: 'Associer une attaque', method: 'POST', path: '/api/pokemons/1/attacks', body: { attackId: 1 } },
      { id: 'attacks-list', label: 'GET /api/attacks', description: 'Lister toutes les attaques', method: 'GET', path: '/api/attacks' },
      { id: 'attack-create', label: 'POST /api/attacks', description: 'Créer une attaque', method: 'POST', path: '/api/attacks', body: () => ({ name: `Attack_${Date.now().toString(36)}`, damage: 25, usageLimit: 10 }) },
      { id: 'battle-random', label: 'POST /api/battles/random', description: 'Duel aléatoire', method: 'POST', path: '/api/battles/random', body: { trainerAId: 1, trainerBId: 2 } },
      { id: 'battle-deterministic', label: 'POST /api/battles/deterministic', description: 'Duel déterministe', method: 'POST', path: '/api/battles/deterministic', body: { trainerAId: 1, trainerBId: 2 } },
      { id: 'arena-random', label: 'POST /api/battles/arena/random', description: 'Arène aléatoire (100 combats)', method: 'POST', path: '/api/battles/arena/random', body: { trainerAId: 1, trainerBId: 2, battlesCount: 100 } },
      { id: 'arena-deterministic', label: 'POST /api/battles/arena/deterministic', description: 'Arène déterministe', method: 'POST', path: '/api/battles/arena/deterministic', body: { trainerAId: 1, trainerBId: 2, battlesCount: 50 } }
    ];

    const baseUrlInput = document.getElementById('base-url');
    const presetList = document.getElementById('preset-list');
    const requestOutput = document.getElementById('request-output');
    const responseOutput = document.getElementById('response-output');
    const responseStatus = document.getElementById('response-status');

    let activePresetId = null;

    const normalizeBase = (value) => {
      if (!value) {
        return window.location.origin;
      }
      const trimmed = value.trim();
      if (/^https?:\/\//i.test(trimmed)) {
        return trimmed.replace(/\/$/, '');
      }
      return `http://${trimmed.replace(/\/$/, '')}`;
    };

    const buildUrl = (path) => {
      if (/^https?:\/\//i.test(path)) {
        return path;
      }
      const base = normalizeBase(baseUrlInput.value);
      return `${base}${path.startsWith('/') ? path : `/${path}`}`;
    };

    const renderPresets = () => {
      presetList.innerHTML = '';
      endpoints.forEach((endpoint) => {
        const button = document.createElement('button');
        button.type = 'button';
        button.className = 'preset';
        if (endpoint.id === activePresetId) {
          button.classList.add('active');
        }

        const title = document.createElement('strong');
        title.textContent = endpoint.label;
        const description = document.createElement('span');
        description.textContent = endpoint.description;

        button.append(title, description);
        button.addEventListener('click', () => {
          activePresetId = endpoint.id;
          renderPresets();
          sendRequest(endpoint);
        });

        presetList.appendChild(button);
      });
    };

    const displayRequest = (data) => {
      requestOutput.textContent = JSON.stringify(data, null, 2);
    };

    const displayResponse = (status, body, isError = false) => {
      responseStatus.textContent = status;
      responseStatus.classList.toggle('error', isError);
      responseStatus.classList.toggle('success', !isError);

      if (body === undefined || body === null || body === '') {
        responseOutput.textContent = '—';
        return;
      }

      if (typeof body === 'string') {
        responseOutput.textContent = body;
        return;
      }

      try {
        responseOutput.textContent = JSON.stringify(body, null, 2);
      } catch (_error) {
        responseOutput.textContent = String(body);
      }
    };

    const resolveBody = (spec) => {
      if (typeof spec === 'function') {
        try {
          return spec();
        } catch (error) {
          console.error('❌ Erreur lors de la génération du corps', error);
          return null;
        }
      }
      if (spec === undefined) {
        return null;
      }
      return JSON.parse(JSON.stringify(spec));
    };

    const sendRequest = async (endpoint) => {
      const url = buildUrl(endpoint.path);
      const bodyPayload = resolveBody(endpoint.body);
      const requestData = {
        method: endpoint.method,
        url,
        body: bodyPayload
      };

      displayRequest(requestData);
      console.log('➡️ Requête envoyée', requestData);

      responseStatus.textContent = 'Envoi en cours…';
      responseStatus.classList.remove('error', 'success');
      responseOutput.textContent = '';

      const init = {
        method: endpoint.method,
        headers: { Accept: 'application/json' }
      };

      if (bodyPayload !== null) {
        init.headers['Content-Type'] = 'application/json';
        init.body = JSON.stringify(bodyPayload);
      }

      const startedAt = performance.now();

      try {
        const response = await fetch(url, init);
        const duration = Math.round(performance.now() - startedAt);
        const text = await response.text();
        let parsed = null;

        if (text) {
          try {
            parsed = JSON.parse(text);
          } catch (_error) {
            parsed = text;
          }
        }

        const headersObject = Object.fromEntries(response.headers.entries());
        const payload = {
          status: response.status,
          statusText: response.statusText,
          durationMs: duration,
          headers: headersObject,
          body: parsed
        };

        console.log('⬅️ Réponse reçue', payload);

  const statusLine = `${response.status} ${response.statusText || ''} · ${duration} ms`;
  displayResponse(statusLine.trim(), payload.body ?? '—', response.status >= 400);
      } catch (error) {
        const duration = Math.round(performance.now() - startedAt);
        const message = error instanceof Error ? error.message : String(error);
        console.error('❌ Erreur réseau', error);
        displayResponse(`Erreur réseau · ${duration} ms`, message, true);
      }
    };

    baseUrlInput.value = window.location.origin;
    renderPresets();
  </script>
</body>
</html>
