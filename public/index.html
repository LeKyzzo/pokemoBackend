<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Simulateur Pokémon minimal</title>
  <style>
    :root {
      color-scheme: light dark;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      --bg: #f4f4f6;
      --fg: #1a1a2b;
      --card: #ffffff;
      --accent: #ffcb05;
      --accent-dark: #0a285f;
      --border: rgba(10, 40, 95, 0.15);
    }

    @media (prefers-color-scheme: dark) {
      :root {
        --bg: #101421;
        --fg: #f4f5ff;
        --card: #181c2c;
        --border: rgba(255, 255, 255, 0.1);
      }
    }

    body {
      margin: 0;
      min-height: 100vh;
      background: var(--bg);
      color: var(--fg);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 2rem 1rem 3rem;
    }

    .app {
      width: min(760px, 100%);
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 1.2rem;
      padding: 2.5rem clamp(1.5rem, 4vw, 3rem);
      box-shadow: 0 30px 60px rgba(15, 23, 42, 0.18);
    }

    h1 {
      margin: 0 0 1rem;
      font-size: clamp(1.75rem, 3vw, 2.4rem);
    }

    p.subtitle {
      margin: 0 0 2.5rem;
      color: rgba(10, 40, 95, 0.75);
      line-height: 1.6;
    }

    form {
      display: grid;
      gap: 1.25rem;
    }

    label {
      display: flex;
      flex-direction: column;
      gap: 0.45rem;
      font-weight: 600;
    }

    input,
    select {
      border: 1px solid var(--border);
      border-radius: 0.75rem;
      padding: 0.65rem 0.8rem;
      font-size: 1rem;
      background: rgba(255, 255, 255, 0.9);
      color: inherit;
    }

    button {
      appearance: none;
      border: none;
      border-radius: 999px;
      padding: 0.8rem 1.5rem;
      font-weight: 700;
      font-size: 1rem;
      background: linear-gradient(135deg, var(--accent), #f6a623);
      color: var(--accent-dark);
      cursor: pointer;
      box-shadow: 0 16px 32px rgba(255, 203, 5, 0.28);
      transition: transform 0.18s ease, box-shadow 0.18s ease, filter 0.18s ease;
    }

    button:disabled {
      cursor: progress;
      filter: grayscale(0.3);
      opacity: 0.85;
      box-shadow: none;
    }

    button:not(:disabled):hover {
      transform: translateY(-1px);
      box-shadow: 0 22px 38px rgba(255, 203, 5, 0.35);
    }

    .results {
      margin-top: 2.5rem;
      border-top: 1px dashed rgba(10, 40, 95, 0.18);
      padding-top: 2rem;
    }

    .panel {
      border: 1px solid var(--border);
      border-radius: 1rem;
      padding: 1.25rem;
      background: rgba(255, 255, 255, 0.65);
      backdrop-filter: blur(16px);
    }

    .status {
      margin-bottom: 1.2rem;
      font-weight: 600;
    }

    pre {
      margin: 0;
      background: #0f172a;
      color: #f8fafc;
      padding: 1rem;
      border-radius: 0.8rem;
      max-height: 260px;
      overflow: auto;
      font-size: 0.92rem;
      line-height: 1.45;
      white-space: pre-wrap;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1rem;
      font-size: 0.95rem;
    }

    th,
    td {
      border-bottom: 1px solid rgba(10, 40, 95, 0.12);
      padding: 0.6rem 0.7rem;
      text-align: left;
    }

    th {
      text-transform: uppercase;
      font-size: 0.75rem;
      letter-spacing: 0.05em;
      color: rgba(10, 40, 95, 0.65);
    }

    .hidden {
      display: none;
    }
  </style>
</head>
<body>
  <main class="app">
    <h1>Simulateur Pokémon</h1>
    <p class="subtitle">Choisissez deux dresseurs, sélectionnez un mode de combat puis laissez l'API REST faire le reste. Les résultats s'affichent instantanément.</p>

    <form id="battle-form">
      <label>
        Identifiant du dresseur A
        <input type="number" name="trainerAId" min="1" step="1" required placeholder="1" />
      </label>
      <label>
        Identifiant du dresseur B
        <input type="number" name="trainerBId" min="1" step="1" required placeholder="2" />
      </label>
      <label>
        Mode de combat
        <select name="mode" required>
          <option value="random-duel">Duel aléatoire</option>
          <option value="deterministic-duel">Duel déterministe</option>
          <option value="arena-random">Arène aléatoire (100 combats)</option>
          <option value="arena-deterministic">Arène déterministe (limite 100)</option>
        </select>
      </label>
      <label id="battles-count-wrapper" class="hidden">
        Nombre de combats pour l'arène
        <input type="number" name="battlesCount" min="1" max="200" step="1" value="100" />
      </label>
      <button type="submit">Lancer</button>
    </form>

    <section class="results hidden" id="results">
      <div class="panel">
        <div class="status" id="status"></div>
        <pre id="log">Aucun combat lancé pour l'instant.</pre>
        <div id="scoreboard-wrapper" class="hidden"></div>
      </div>
    </section>
  </main>

  <script>
    const ROUTES = {
      'random-duel': '/api/battles/random',
      'deterministic-duel': '/api/battles/deterministic',
      'arena-random': '/api/battles/arena/random',
      'arena-deterministic': '/api/battles/arena/deterministic'
    };

    const form = document.getElementById('battle-form');
    const statusEl = document.getElementById('status');
    const logEl = document.getElementById('log');
    const resultsSection = document.getElementById('results');
    const scoreboardWrapper = document.getElementById('scoreboard-wrapper');
    const submitButton = form.querySelector('button[type="submit"]');
    const battlesCountWrapper = document.getElementById('battles-count-wrapper');

    const formatDuel = (duel) => {
      const lines = [];
      if (!duel) {
        return 'Aucun résultat.';
      }
      lines.push(`Mode : ${duel.mode}`);
      lines.push(`Rounds : ${duel.totalRounds}`);
      lines.push(`A : ${duel.trainerA.name} (${duel.trainerA.pokemon})`);
      lines.push(`B : ${duel.trainerB.name} (${duel.trainerB.pokemon})`);
      if (duel.winner) {
        lines.push(`Vainqueur : ${duel.winner.trainerName} (${duel.winner.pokemonName})`);
      } else {
        lines.push('Vainqueur : égalité');
      }
      lines.push('---');
      duel.turns.forEach((turn) => {
        if (turn.action === 'attack') {
          lines.push(
            `Tour ${turn.round} • ${turn.actor.trainerName} (${turn.actor.pokemonName}) utilise ${turn.attackName} → ${turn.damage} dmg | ${turn.target.pokemonName} : ${turn.targetRemainingLife} PV`
          );
        } else {
          lines.push(
            `Tour ${turn.round} • ${turn.actor.trainerName} (${turn.actor.pokemonName}) ne peut pas attaquer`
          );
        }
      });
      return lines.join('\n');
    };

    const renderScoreboard = (arena) => {
      if (!arena || !Array.isArray(arena.scoreboard)) {
        scoreboardWrapper.classList.add('hidden');
        scoreboardWrapper.innerHTML = '';
        return;
      }
      scoreboardWrapper.classList.remove('hidden');
      const table = document.createElement('table');
      const thead = document.createElement('thead');
      const headerRow = document.createElement('tr');
      ['Dresseur', 'Victoires', 'Défaites', 'Nuls'].forEach((label) => {
        const th = document.createElement('th');
        th.textContent = label;
        headerRow.appendChild(th);
      });
      thead.appendChild(headerRow);
      table.appendChild(thead);

      const tbody = document.createElement('tbody');
      arena.scoreboard.forEach((row) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${row.trainerName}</td><td>${row.wins}</td><td>${row.losses}</td><td>${row.draws}</td>`;
        tbody.appendChild(tr);
      });
      table.appendChild(tbody);

      const notes = Array.isArray(arena.notes) && arena.notes.length
        ? `<ul>${arena.notes.map((note) => `<li>${note}</li>`).join('')}</ul>`
        : '';

      scoreboardWrapper.innerHTML = `
        <h3>Statistiques d'arène</h3>
        <div><strong>Combats joués :</strong> ${arena.totalBattles}</div>
        ${arena.champion ? `<div><strong>Champion :</strong> ${arena.champion.trainerName}</div>` : '<div><strong>Champion :</strong> égalité</div>'}
        ${table.outerHTML}
        ${notes}
      `;
    };

    const toggleArenaFields = (mode) => {
      if (mode.startsWith('arena')) {
        battlesCountWrapper.classList.remove('hidden');
      } else {
        battlesCountWrapper.classList.add('hidden');
      }
    };

    form.mode.addEventListener('change', (event) => {
      toggleArenaFields(event.target.value);
    });

    form.addEventListener('submit', async (event) => {
      event.preventDefault();
      const formData = new FormData(form);
      const mode = formData.get('mode');
      const trainerAId = Number(formData.get('trainerAId'));
      const trainerBId = Number(formData.get('trainerBId'));
      const battlesCount = Number(formData.get('battlesCount'));

      if (!ROUTES[mode]) {
        statusEl.textContent = 'Mode de combat inconnu.';
        resultsSection.classList.remove('hidden');
        return;
      }

      submitButton.disabled = true;
      statusEl.textContent = 'Simulation en cours...';
      logEl.textContent = '';
      resultsSection.classList.remove('hidden');
      scoreboardWrapper.classList.add('hidden');
      scoreboardWrapper.innerHTML = '';

      try {
        const payload = { trainerAId, trainerBId };
        if (mode.startsWith('arena') && Number.isFinite(battlesCount) && battlesCount > 0) {
          payload.battlesCount = Math.min(Math.floor(battlesCount), 200);
        }

        const response = await fetch(ROUTES[mode], {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        if (!response.ok) {
          const message = await response.text();
          throw new Error(message || `Erreur ${response.status}`);
        }

        const data = await response.json();
        if (mode.startsWith('arena')) {
          const latestBattle = Array.isArray(data.battles) && data.battles.length
            ? data.battles[data.battles.length - 1]
            : null;
          statusEl.textContent = latestBattle && latestBattle.winner
            ? `Dernier vainqueur : ${latestBattle.winner.trainerName}`
            : 'Dernier combat : égalité';
          logEl.textContent = latestBattle ? formatDuel(latestBattle) : 'Pas de duel enregistré.';
          renderScoreboard(data);
        } else {
          statusEl.textContent = data.winner
            ? `Victoire de ${data.winner.trainerName}`
            : 'Match nul';
          logEl.textContent = formatDuel(data);
        }
      } catch (error) {
        statusEl.textContent = error instanceof Error ? error.message : String(error);
        logEl.textContent = '—';
      } finally {
        submitButton.disabled = false;
      }
    });

    toggleArenaFields(form.mode.value);
  </script>
</body>
</html>
